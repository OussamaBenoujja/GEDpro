name: Docker Compose CI/CD

on:
  push: 
    branches: [ "main" ]
  pull_request: 
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses:  actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker Compose services
      run: docker compose build

    - name: Start Docker Compose services
      run: docker compose up -d

    - name: Wait for services to be ready
      run:  |
        echo "Waiting for services to start..."
        sleep 10
        docker compose ps

    - name: Run tests
      run: |
        # Option 1: Run tests in a specific service container
        docker compose exec -T <your-service-name> npm test
        
        # Option 2: Run a dedicated test service if you have one
        # docker compose run --rm test
        
        # Option 3: Run tests with docker compose
        # docker compose -f docker-compose.yml -f docker-compose.test.yml up --abort-on-container-exit

    - name: Show logs on failure
      if: failure()
      run: docker compose logs

    - name: Stop Docker Compose services
      if: always()
      run: docker compose down -v

    - name: Login to Docker Hub (optional - for deployment)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses:  docker/login-action@v3
      with:
        username:  ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push images (optional - for deployment)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: docker compose push
